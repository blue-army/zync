<link href="../../bower_components/iron-ajax/iron-ajax.html" rel="import">
<link href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html" rel="import">
<link href="../../bower_components/paper-icon-button/paper-icon-button.html" rel="import">
<link href="../misc/my-icons.html" rel="import">
<script src="https://secure.aadcdn.microsoftonline-p.com/lib/0.1.1/js/msal.min.js"></script>

<dom-module id="user-signin-service">
  <template>
    <style type="text/css">
      #btn-message {
        padding-right: 6px;
      }
    </style>
    <template is="dom-if" if={{userObj}}>
      <span>Welcome, {{userObj.name}}</span>
    </template>
    <paper-button on-tap="handleSignin" active="true" toggles>
      <span id="btn-message">{{getMessage(userObj)}}</span>
      <iron-icon icon="{{_icon(userObj)}}"></iron-icon>
    </paper-button>
  </template>
</dom-module>

<script>
    Polymer({
      is: 'user-signin-service',

      properties: {
        loggedIn: {
          type: Boolean,
          computed: 'getLoginStatus(userObj)'
        },

        userObj: {
          type: Object,
          computed: 'getUserInfo(userAgentApplication)'
        },

        authority: {
          type: String,
          readOnly: true,
          value: "https://login.microsoftonline.com/common"
        },

        clientID: {
          type: String,
          value: 'bababc50-4dad-45b5-a10f-5b98129ccf1d',
          readOnly: true
        },

        scopes: {
          type: Array,
          value: [
              "user.read", 
              'https://graph.microsoft.com/Group.ReadWrite.All',
              'https://graph.microsoft.com/User.ReadWrite.All'
            ]
        },

        userAgentApplication: {
          type: Object
        }
      },

      // create the msal object once all the properties have been set
      ready: function () {
        if (window.msal) {
          this.userAgentApplication = window.msal;
        }
        var agent = new Msal.UserAgentApplication(
                    this.clientID, 
                    this.authority,
                    this.loginCallback);
            // set redirectUri - otherwise it defaults to window.location.href
            agent.redirectUri = window.location.protocol + "//" + window.location.host + "/code_callback";
            this.userAgentApplication = agent;
      },

      // Returns the user object from the MSAL instance, if a user is logged in
      getUserInfo: function(userAgentApplication) {
        if (userAgentApplication) {
          return userAgentApplication.getUser();
        }
        return null;
      },

      // Starts the process of retrieving an access token (either from storage or through redirect)
      // The user-token-response event is fired when token has been retrieved
      getToken: function () {
        if (this.userObj) {
          // If user is logged in, try retrieving token from storage
          this.userAgentApplication.acquireTokenSilent(this.scopes)
            .then((accessToken) => {
              // retrieved a valid token -> fire user-token-response event
              console.log("Access token retrieved from storage: ", accessToken);
              this.fire('user-token-response', {token: accessToken, scopes: this.scopes});
            }).catch((error) => {
              // couldn't retrieve a token from storage -> perform redirect
              console.log("Could not retrieve token from storage. ", error);
              this.userAgentApplication.acquireTokenRedirect(this.scopes);
            });

        } else {
          // redirect to MS login page if user is not logged in
          this.login();   
        }
      },

      // function called after loginRedirect or acquireTokenRedirect
      // Fires user-token-response event if an access token has been retrieved
      loginCallback: function (errorDesc, token, error, tokenType) {
        if (token) {
          console.log("Token acquired! ", tokenType, ": ", token);
          if (tokenType === "access_token") {
            this.fire('user-token-response', {token: accessToken, scopes: this.scopes});
          }
        } else {
          console.log("Login error: ", error, errorDesc);
        }
      },

      // Triggers redirect to the 'log in with Microsoft' page
      login: function () {
        console.log("scopes on redirect: ", this.scopes)
        this.userAgentApplication.loginRedirect(this.scopes);
      },

      // Log out the current user
      logout: function() {
          // Removes all sessions, need to call AAD endpoint to do full logout
          this.userAgentApplication.logout();
      },

      getLoginStatus: function(userObj) {
        if (userObj) {
          return true;
        }
        return false;
      },

      // specifies the action triggered by the signin button
      handleSignin: function(e) {
        if (!this.userObj) {
          this.login();   // if no user, log in
        } else {
          this.logout();
        }
      },

      // get button message
      getMessage: function(userObj) {
        if (userObj) {
          return "Log out";
        }
        return "Login with Microsoft"
      },

      // get button icon
      _icon: function (userObj) {
        return userObj ? "my-icons:ms-signout" : "my-icons:ms-signin";
      }
    });
</script>